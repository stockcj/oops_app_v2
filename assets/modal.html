<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://assets.zendesk.com/apps/sdk-assets/css/2/zendesk_garden.css" type="text/css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
</head>

<body>
    <h2 class="u-gamma u-light">You wrote the below message:</h2>
    <hr />
    <div id="container">
        <p id="message_to_save"></p>
    </div>
    <div id="footer">
        <p id="timer_message">Time Remaining: &nbsp; &nbsp;<span id="tick_timer">10</span></p>
        <button id="save-ticket-submit" class="c-btn c-btn--small c-btn--pill c-btn--primary">Save</button>
        <button id="cancel-ticket-submit" class="c-btn c-btn--small c-btn--pill">Abort</button>
    </div>
    <script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
    <script>
        let modalClient = ZAFClient.init();
        let comment = null;
        let tick = null;
        let tickTimer = null;
        let stopped = false;
        let parentClient = null;

        modalClient.on('sending_parent_client_guid', (parentClientGuid) => {
            console.log('parentClientGuid set');
            parentClient = modalClient.instance(parentClientGuid);
        });
        modalClient.on('sending_comment_and_tick', (commentAndTick) => {
            console.log('comment and tick received');
            comment = commentAndTick['comment'];
            tick = commentAndTick['tick'];
            
            $('p#message_to_save').append(comment);
            $('#tick_timer').text(tick);

            tickTimer = setInterval(() => {
                if (stopped) {
                    clearInterval(tickTimer);
                    parentClient.trigger('modal.cancel');
                } else {
                    tick--;
                    $('#tick_timer').text(tick);
                    if (tick === 0) {
                        clearInterval(tickTimer);
                        parentClient.trigger('modal.save');
                    }
                }
            }, 1000);
        });
        // Resize model to be 40% of parent window.
        modalClient.invoke('resize', {
            width: '40vw',
            height: '40vh'
        });
        // Use if an action is needed when user clicks 'X' or clicks outside of modal.
        modalClient.on('modal.close', () => {
            stopped = true;
            parentClient.trigger('modal.cancel');
        });

        modalClient.on('ticket.submit.always', cleanTimer);

        function cleanTimer() {
            clearInterval(tickTimer);
        }
        
        $(document).ready(() => {
            $("#cancel-ticket-submit").click(() => {
                stopped = true;
                parentClient.trigger('modal.cancel');
            });
            $("#save-ticket-submit").click(() => parentClient.trigger('modal.save'));
        })
    </script>
</body>

</html>