<html>
<head>
  <meta charset="utf-8">
  <!-- Zendesk CSS styles -->
  <link rel="stylesheet" href="https://assets.zendesk.com/apps/sdk-assets/css/2/zendesk_garden.css" type="text/css">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
</head>
<body>
  <section data-main>Loading...</section>
  <script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  <script>
    var stopped;
    var tickTimer;
    var delay;

    var client = ZAFClient.init();

    client.on('ticket.submit.always', cleanTimer);
    client.on('ticket.save', save);

    function init(location) {
      location === 'modal' ? new ModalApp() : new TicketApp();
    }

    function mainEl() {
      return $('section[data-main]');
    }

    function getDelay() {
      var myDelay = localStorage.getItem('ticketSubmissionUserDelay') || 10;
      return myDelay;
    }

    function cleanTimer() {
      clearInterval(tickTimer);
    }

    function save() {
      return new Promise(function(resolve, reject) {
        client.get('ticket.comment').then(function(data) {
          var comment_text = data['ticket.comment']['text'];
          if (comment_text.length < 1) {return true;};
          var tick = getDelay();
          if (tick <= 0) { return true; };
          client.context().then(function(context){
            var parent_guid = context.instanceGuid;
            var options = {
              location: 'modal',
              url: 'assets/iframe.html#parent_guid=' + parent_guid
            }
            return client.invoke('instances.create', options).then(function(data) {
              var instanceGuid = data['instances.create'][0].instanceGuid;
              var modalClient = client.instance(instanceGuid);
              modalClient.on('modal.save', function() {
                resolve();
              });
              modalClient.on('modal.cancel', function() {
                reject('Cancel');
              })
            });
          })
        })
      })
    }

    var TicketApp = function() {
      delay = localStorage.getItem('ticketSubmissionUserDelay') || 10;
      this.render(delay);
    }

    TicketApp.prototype = {
      render: function(delay) {
        mainEl().html(`
          <div id="delay-settings">
            <span id="delay-settings-label">Ticket submissions delay seconds</span>
            <select id="delay-settings-dropdown"  class="c-txt__input c-txt__input--select">
              <option value="0">Off</option>
              <option value="3">3</option>
              <option value="5">5</option>
              <option value="7">7</option>
              <option value="10">10</option>
            </select>
          </div>
        `);
        $("#delay-settings-dropdown").val(delay);
        $('#delay-settings-dropdown').change(this.updateSettings);
        client.invoke('resize', { width: '100%', height: 'auto' });
      },

      updateSettings: function() {
        var userDelay = parseInt($('#delay-settings-dropdown').children('option:selected').val(), 10);
        localStorage.setItem('ticketSubmissionUserDelay', userDelay);
      },

    };

    var ModalApp = function() {
      this.render();
    };

    ModalApp.prototype = {
      render: function() {
        mainEl().html(`
          <h2 class="u-gamma u-light">You wrote the below message:</h2>
          <hr />
          <div id="container">
            <p id="message_to_save"></p>
          </div>
          <div id="footer">
            <p id="timer_message">Time Remaining: &nbsp; &nbsp;<span id="tick_timer">10</span></p>
            <button id="save-ticket-submit" class="c-btn c-btn--small c-btn--pill c-btn--primary">Save</button>
            <button id="cancel-ticket-submit" class="c-btn c-btn--small c-btn--pill">Abort</button>
          </div>
        `);
        $('#cancel-ticket-submit').click(function() {
          stopped = true;
          client.trigger('modal.cancel');
          client.invoke('destroy');
        });
        $('#save-ticket-submit').click(function() {
          client.trigger('modal.save');
          client.invoke('destroy');
        });
        var params = this.parseParams(window.location.hash);
        var pc = this.getParentClient(params.parent_guid);
        client.invoke('resize', { height: '40vh', width: '40vw'})
        tick = getDelay();
        this.setComment(pc);
        this.setTick(tick);
        this.startTimer(tick);
      },

      parseParams: function(param_string) {
        var param_sub = param_string.replace('#', '').split('&');
        var param_obj = _.reduce(param_sub, function(memo, k) {
          kv = k.split('=');
          memo[kv[0]] = kv[1];
          return memo
        }, {});
        return param_obj;
      },

      getParentClient: function(parent_guid) {
        return client.instance(parent_guid)
      },

      setTick: function(tick) {
        $('#tick_timer').text(tick);
      },

      setComment: function(parent_client) {
        parent_client.get('ticket.comment').then(function(data) {
          var comment_text = data['ticket.comment']['text'];
          $('div#container').append(comment_text);
        })
      },

      startTimer: function(tick) {
        tickTimer = setInterval(function () {
          if (stopped) {
            clearInterval(tickTimer);
            client.trigger('modal.cancel');
          } else {
            tick--;
            $('#tick_timer').text(tick);
            if (tick === 0) {
              clearInterval(tickTimer);
              client.trigger('modal.save');
            }
          }
        }, 1000);
      }


    };

    client.on('app.registered', function(data) {
      init(data.context.location);
    });

  </script>
</body>
</html>